<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üçΩÔ∏è Men√∫ - Restaurante</title>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"/>
  <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            darkbg: "#0a0a0a",
            card: "#1a1a1a",
            accent: "#facc15",
            accentDark: "#d4af37"
          }
        }
      }
    };
  </script>

  <style>
    .menu-img { object-fit: cover; height: 160px; width: 100%; }
    body { font-family: "Poppins", sans-serif; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #222;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: 0.3s ease;
      z-index: 9999;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body class="min-h-screen bg-darkbg text-gray-100">
  <nav class="bg-card border-b border-gray-700 shadow-md">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold text-accent">üçî Mi Restaurante</h1>
    </div>
  </nav>
  <main class="container mx-auto px-4 py-8">
    <div class="flex flex-col sm:flex-row gap-4 mb-8 items-start">
      <div class="relative flex-1 w-full">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
        <input id="search" type="search" placeholder="Buscar platillos..."
          class="pl-10 pr-3 py-2 w-full border border-gray-700 rounded-md bg-card text-gray-100 focus:outline-none focus:ring focus:ring-accent focus:border-accent" />
      </div>
      <div id="categories" class="flex gap-2 flex-wrap"></div>
    </div>
    <div class="grid lg:grid-cols-4 gap-8">
      <section id="menuItems" class="lg:col-span-3">
        <div id="menuGrid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>

        <div id="noResults" class="text-center py-12 hidden">
          <p class="text-accent">No se encontraron platillos que coincidan con tu b√∫squeda.</p>
        </div>
      </section>
      <aside class="lg:col-span-1 bg-card border border-gray-700 rounded-lg p-4 shadow-lg sticky top-6">
        <h2 class="text-lg font-semibold mb-4 text-accent">üßæ Resumen de la orden</h2>
        <div id="cartItems" class="space-y-3 mb-4">
          <p class="text-sm text-gray-400">No hay art√≠culos en el carrito.</p>
        </div>

        <div class="flex items-center justify-between mb-4">
          <div class="text-sm font-medium text-gray-200">Total</div>
          <div id="cartTotal" class="text-lg font-semibold text-accent">$MXN 0.00</div>
        </div>
        <button id="submitOrder" class="w-full bg-accent text-gray-900 py-2 rounded-md hover:bg-accentDark transition disabled:opacity-50">Enviar pedido</button>
      </aside>
    </div>
  </main>
  <div id="successModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="bg-card rounded-lg p-6 w-11/12 max-w-md text-center text-gray-100 border border-gray-700">
      <h3 class="text-2xl font-bold mb-2 text-accent">‚úÖ ¬°Pedido enviado!</h3>
      <p class="mb-4">N√∫mero de orden: <span id="orderNumber" class="font-mono text-lg bg-gray-700 px-2 py-1 rounded-md text-accent"></span></p>
      <button id="closeModal" class="px-4 py-2 bg-accent text-gray-900 rounded-md">Cerrar</button>
    </div>
  </div>
  <div id="optionModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="bg-card rounded-lg p-6 w-11/12 max-w-md text-center text-gray-100 border border-gray-700">
      <h3 id="optionModalTitle" class="text-xl font-bold mb-4 text-accent">Selecciona una opci√≥n</h3>
      <div id="optionButtons" class="flex flex-col gap-2 mb-4"></div>
      <div class="flex justify-end gap-2">
        <button id="optionCancel" class="px-4 py-2 bg-gray-600 text-white rounded-md">Cancelar</button>
        <button id="optionAceptar" class="px-4 py-2 bg-accent text-gray-900 rounded-md">Aceptar</button>
      </div>
    </div>
  </div>

<audio id="notifSound" src="./not.mp3" preload="auto"></audio>

<script>
const menuItems = [
  { id: '1', name: 'Tacos al pastor', description: 'Con pi√±a y salsa (Orden 5 tacos)', price: 40, image: 'tacos.jpg', category: 'Tacos', options: ['Con pi√±a', 'Con extra salsa', 'Doble tortilla', 'media orden'] },
  { id: '2', name: 'Tacos de bistec', description: 'Con cebolla', price: 85, image: 'tacos_B.jpg', category: 'Tacos', options: ['Con queso', 'Con salsa', 'Doble tortilla'] },
  { id: '3', name: 'Quesadilla de pollo', description: 'Tortilla doble, queso', price: 95, image: 'quesadilla_P.jpg', category: 'Quesadillas', options: ['Con pi√±a', 'Extra queso', 'Doble tortilla'] },
  { id: '4', name: 'Agua de horchata', description: 'Casa', price: 25, image: 'agua_orchata.jpg', category: 'Bebidas', options: ['Escarchado', 'Hielo'] },
  { id: '5', name: 'Michelada (Laton)', description: 'Con borde escarchado', price: 60, image: 'michelada_l.jpg', category: 'Bebidas', options: ['Camaron', 'Surimi', 'Escarchado'] },
  { id: '6', name: 'Michelada (Cahuama)', description: 'Con borde escarchado', price: 100, image: 'michelada_c.jpg', category: 'Bebidas', options: ['Camaron', 'Surimi', 'Escarchado'] },
  { id: '7', name: 'Tacos de pescado', description: 'Rebozado', price: 110, image: 'tacos_pesaco.jpg', category: 'Tacos', options: ['Con salsa', 'Con lim√≥n', 'Doble tortilla'] }
];

const categories = ['all', ...Array.from(new Set(menuItems.map(i => i.category)))];

const params = new URLSearchParams(window.location.search);
const mesaId = params.get('mesa') || 'Sin mesa';

let selectedCategory = 'all';
let searchTerm = '';
const cart = [];

const categoriesEl = document.getElementById('categories');
const menuGrid = document.getElementById('menuGrid');
const noResultsEl = document.getElementById('noResults');
const searchInput = document.getElementById('search');
const cartItemsEl = document.getElementById('cartItems');
const cartTotalEl = document.getElementById('cartTotal');
const submitBtn = document.getElementById('submitOrder');
const successModal = document.getElementById('successModal');
const orderNumberEl = document.getElementById('orderNumber');
const closeModalBtn = document.getElementById('closeModal');
const optionModal = document.getElementById('optionModal');
const optionButtonsEl = document.getElementById('optionButtons');
const optionCancelBtn = document.getElementById('optionCancel');
const optionAceptarBtn = document.getElementById('optionAceptar');
const optionModalTitle = document.getElementById('optionModalTitle');

let selectedItemForOptions = null;

function renderCategories() {
  categoriesEl.innerHTML = '';
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat === 'all' ? 'Todos' : cat;
    btn.className = `py-1 px-3 rounded-md border ${selectedCategory === cat ? 'bg-yellow-600 text-white' : 'bg-gray-800 text-yellow-400 border-yellow-600 hover:bg-yellow-600 hover:text-white'}`;
    btn.addEventListener('click', () => {
      selectedCategory = cat;
      renderCategories();
      renderMenu();
    });
    categoriesEl.appendChild(btn);
  });
}

function formatPrice(v) {
  return '$MXN ' + Number(v).toFixed(2);
}

function filteredItems() {
  const term = searchTerm.trim().toLowerCase();
  return menuItems.filter(item => {
    const matchesCategory = selectedCategory === 'all' || item.category === selectedCategory;
    const matchesSearch = !term || item.name.toLowerCase().includes(term) || item.description.toLowerCase().includes(term);
    return matchesCategory && matchesSearch;
  });
}

function renderMenu() {
  const items = filteredItems();
  menuGrid.innerHTML = '';
  if (items.length === 0) {
    noResultsEl.classList.remove('hidden');
    return;
  } else {
    noResultsEl.classList.add('hidden');
  }

  items.forEach(item => {
    const card = document.createElement('article');
    card.className = 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden shadow-md hover:shadow-yellow-600/30 transition';

    const imgWrap = document.createElement('div');
    imgWrap.className = 'h-40 overflow-hidden';
    const img = document.createElement('img');
    img.src = item.image;
    img.alt = item.name;
    img.className = 'w-full h-full object-cover menu-img';
    imgWrap.appendChild(img);

    const body = document.createElement('div');
    body.className = 'p-4';
    body.innerHTML = `
      <h3 class="font-semibold text-lg mb-1 text-yellow-400">${item.name}</h3>
      <p class="text-sm mb-3 text-gray-300">${item.description}</p>
      <div class="flex items-center justify-between">
        <div class="font-semibold text-yellow-300">${formatPrice(item.price)}</div>
        <button class="addBtn px-3 py-1 rounded-md bg-yellow-600 text-gray-900 hover:bg-yellow-500 transition">Agregar</button>
      </div>
    `;

    const addBtn = body.querySelector('.addBtn');
    addBtn.addEventListener('click', () => openOptionModal(item));

    card.appendChild(imgWrap);
    card.appendChild(body);
    menuGrid.appendChild(card);
  });
}

function openOptionModal(item) {
  selectedItemForOptions = { ...item, selectedOptions: [] };
  optionModalTitle.textContent = `Opciones para: ${item.name}`;
  optionButtonsEl.innerHTML = '';

  if (item.options && item.options.length > 0) {
    item.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.textContent = opt;
      btn.className = 'px-4 py-2 border rounded-md bg-gray-700 text-gray-200 hover:bg-yellow-600 hover:text-gray-900 transition';
      btn.addEventListener('click', () => {
        const index = selectedItemForOptions.selectedOptions.indexOf(opt);
        if (index === -1) {
          selectedItemForOptions.selectedOptions.push(opt);
          btn.classList.add('bg-yellow-600', 'text-gray-900');
        } else {
          selectedItemForOptions.selectedOptions.splice(index, 1);
          btn.classList.remove('bg-yellow-600', 'text-gray-900');
        }
      });
      optionButtonsEl.appendChild(btn);
    });
  } else {
    optionButtonsEl.innerHTML = `<p class="text-gray-400">Este platillo no tiene opciones adicionales.</p>`;
  }

  optionModal.classList.remove('hidden');
  optionModal.style.display = 'flex';
}

optionAceptarBtn.addEventListener('click', () => {
  if (!selectedItemForOptions) return;
  if (!selectedItemForOptions.selectedOptions.length) selectedItemForOptions.selectedOptions = ['Sin cambios'];

  const itemToAdd = {
    ...selectedItemForOptions,
    selectedOption: selectedItemForOptions.selectedOptions.join(', ')
  };

  addToCart(itemToAdd);
  closeOptionModal();
});

function closeOptionModal() {
  optionModal.classList.add('hidden');
  optionModal.style.display = 'none';
  selectedItemForOptions = null;
}

function addToCart(item) {
  const existing = cart.find(c => c.id === item.id && c.selectedOption === item.selectedOption);
  if (existing) existing.qty++;
  else cart.push({ ...item, qty: 1 });
  renderCart();
}

function removeFromCart(itemId, option) {
  const idx = cart.findIndex(c => c.id === itemId && c.selectedOption === option);
  if (idx !== -1) cart.splice(idx, 1);
  renderCart();
}

function changeQty(itemId, delta, option) {
  const it = cart.find(c => c.id === itemId && c.selectedOption === option);
  if (!it) return;
  it.qty += delta;
  if (it.qty < 1) removeFromCart(itemId, option);
  renderCart();
}

function cartTotal() {
  return cart.reduce((s, i) => s + i.price * i.qty, 0);
}

function renderCart() {
  cartItemsEl.innerHTML = '';
  if (!cart.length) {
    cartItemsEl.innerHTML = `<p class="text-sm text-gray-400">No hay art√≠culos en el carrito.</p>`;
    submitBtn.disabled = true;
  } else {
    cart.forEach(ci => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';
      row.innerHTML = `
        <div>
          <div class="font-medium text-yellow-400">${ci.name} (${ci.selectedOption})</div>
          <div class="text-sm text-gray-300">${formatPrice(ci.price)} x ${ci.qty}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-2 border border-yellow-500 text-yellow-400 rounded" data-action="dec">-</button>
          <span class="w-6 text-center text-gray-200">${ci.qty}</span>
          <button class="px-2 border border-yellow-500 text-yellow-400 rounded" data-action="inc">+</button>
        </div>
      `;
      const dec = row.querySelector('[data-action="dec"]');
      const inc = row.querySelector('[data-action="inc"]');
      dec.addEventListener('click', () => changeQty(ci.id, -1, ci.selectedOption));
      inc.addEventListener('click', () => changeQty(ci.id, +1, ci.selectedOption));
      cartItemsEl.appendChild(row);
    });
    submitBtn.disabled = false;
  }
  cartTotalEl.textContent = formatPrice(cartTotal());
}

async function submitOrder() {
  if (!cart.length) return;

  const order = {
    id: `order-${Date.now()}`,
    mesa: mesaId,
    items: cart.map(c => ({
      name: c.name,
      specifications: c.selectedOption,
      qty: c.qty,
      price: c.price
    })),
    total: cartTotal(),
    status: 'pendiente',
    createdAt: new Date().toISOString()
  };


  localStorage.setItem("pedidoActual", order.id);

  try {
    await fetch('save_order.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(order)
    });

    cart.length = 0;
    renderCart();

    orderNumberEl.textContent = order.id.split('-')[1];
    successModal.classList.remove('hidden');
    successModal.style.display = 'flex';
  } catch (err) {
    alert('Error al guardar el pedido. Verifica tu conexi√≥n.');
    console.error(err);
  }
}

function closeModal() {
  successModal.classList.add('hidden');
  successModal.style.display = 'none';
}

searchInput.addEventListener('input', e => { searchTerm = e.target.value; renderMenu(); });
submitBtn.addEventListener('click', submitOrder);
closeModalBtn.addEventListener('click', closeModal);
optionCancelBtn.addEventListener('click', closeOptionModal);

function notify(msg) {
  alertify.set('notifier','position', 'bottom-right');
  alertify.notify(msg, 'success', 4);
}

//estado
let ultimoEstado = null;

async function revisarEstadoPedido() {
  const orderId = localStorage.getItem("pedidoActual");
  if (!orderId) return;

  try {
    const response = await fetch("orders.json");
    const orders = await response.json();

    const pedido = orders.find(o => o.id === orderId);
    if (!pedido) return;

    if (ultimoEstado !== pedido.status) {
      if (ultimoEstado !== null) {
        notify("Tu pedido ahora est√°: " + pedido.status.toUpperCase());
        playSound();
      }
      ultimoEstado = pedido.status;
    }

  } catch (e) {
    console.error("Error revisando el pedido:", e);
  }
}

function playSound() {
  const audio = new Audio("not.mp3");
  audio.play();
}


setInterval(revisarEstadoPedido, 3000);
renderCategories();
renderMenu();
renderCart();


</script>
</body>
</html>